README

perdition
Mail retreival proxy server
Copyright (C) 1999  Horms <horms@vergenet.net>
----------------------------------------------------------------------


Overview
--------

Perdition is allows users to connect to a content-free POP3 or
IMAP4 server that will redirect them to their real POP3 or IMAP4
server respectively. This enables mail retrieval for a domain to
be split across multiple real mail servers on a per user basis.
This can also be used to as a POP3 or IMAP4 proxy especially in
firewall applications.

When a connection is made to perdition in POP3 mode, it reads the 
USER and PASS commands and then refers to its popmap to find
where the user's connection should be forwarded to. A connection
to the foreign pop server, perdition then enders the USER and
PASS commands to the foreign server. If authentication is
successful then perdition pipes data between the client and the
foreign server.  If authentication fails then the foreign server
connection is closed and the client connection is reset to the
state it was in on initial connection. That is new USER and PASS
commands are expected. Similarly in IMAP4 mode, perdition accepts
the LOGIN command and passes the username and password onto the
back-end IMAP4 server specified in the popmap for authentication.

At this stage the only capabilities supported by perdition in
IMAP4 mode is IMAP4 and no authentication schemes, other than
the LOGIN command are accepted.


Options
-------

A number of command line options are provided to control perdition's behavior.

Usage: perdition [options]
  options:
     -a|--authenticate_in:
                      User is authenticated by perdition before
                      connection to backend server is made.
     -b|--bind_address:
                      Bind to interfaces with this address.
                      If NULL then bind to all interfaces.
                      (default "(null)")
     -c|--client_server_specification:
                      Allow USER of the form ser<delimiter>server[:port]
                      to specify the server and port for a user.
                      Note: over-rides -s|--strip_domain.
     -D|--domain_delimiter:
                      Delimiter used for
                      -c|--client_server_specification and
                      -s|--strip_domain options. Multicharacter
                      delimiters are permitted.
                      (default "@")
     -d|--debug:      Turn on verbose debuging to syslog.
     -f|--config_file:
                      Name of config file to read. If set to "" no
                      config file will be used. Command line options
                      override options set in config file.
                      (default "/etc/perdition/perdition.conf")
     -g|--group:      Group to run as.
                      (default "nobody")
     -h|--help:       Display this message
     -i|--inetd_mode: Run in inetd mode
     -L|--connection_limit:
                      Maximum number of connections to accept
                      simultaneously. A value of zero sets
                      no limit on the number of simultaneous
                      connections.
                      (default 0)
     -l|--listen_port:
                      Port to listen on.
                      (default "protocol dependent")
     -M|--map_library:
                      Library to open that provides functions to look
                      up the server for a user. A null library mean
                      no library will be accessed and hence, no lookup
                      will take place.
                      (default "/usr/lib/libperditiondb_gdbm.so")
     -m|--map_library_opt:
                      String option to pass to databse access function
                      provided by the library specified by the
                      -M|--map_library option. The treatment of this
                      string is up to the library, in the case of
                      perditiondb_gdbm the gdbm map to access is set.
                      (default "(null)")
     -o|--server_ok_line:
                      If authentication with the back-end server is
                      successful then send the servers +OK line to
                      the client, instead of generting one
     -P|--protocol:   Protocol to use.
                      (default "POP3")
                      available protocols: "POP3, IMAP4"
     -p|--outgoing_port:
                      Define a port to use if a port is not defined for
                      a user in popmap, or a default server if it is
                      used.
                      (default "protocol dependent")
     -s|--outgoing_server:
                      Define a server to use if a user is not in the
                      popmap. Format is servername[:port]. Multiple
                      servers can be delimited by a ','. If multiple
                      servers are specified then they are used in a
                      round robin.
                      (default "(null)")
     -S|--strip_domain:
                      Allow USER of the from user<delimiter>domain where
                      <delimiter>domain will be striped off
                      Note: over-ridden by
                      -c|--client_server_specification
     -t|--timeout:    Idle timeout in seconds. Value of zero sets
                      infinite timeout.
                      (default 1800)
     -u|--username:   Username to run as
                      (default "nobody")

     Note: default value for binary flags is off


User Database
-------------

For information on mechanisms for resolving users to a host and port and
information on the -M|--map_library and -m|--map_library_opt flags, please
see README.perditiondb.


Stand Alone Mode
----------------

Normally perdition will bind to a port, and listen for connections.  The
default port is 110 in POP3 mode and 143 in IMAP4 mode, an alternate port
can be specified with the -p command line option. In this mode perdition
will fork to manage clients.

In the RPM distribution perdition can be started and stopped in stand alone
mode using:

/etc/rc.d/init.d/perdition start
and 
/etc/rc.d/init.d/perdition stop

Editing /etc/sysconfig/perdition allows control of weather perdition
will be started in POP3 mode, IMAP4 mode or both (or neither).

The sytax for this file is:
POP3=[on|off]
IMAP4=[on|off]

The file is sourced into the init script so normal bash syntax
applies. Blank lines are ignored, as is anything after a # on a line.

e.g.

POP3=on
IMAP4=on

If you are using the RPM and you do not want perdition to run in stand
alone mode at boot up after installation run:

/sbin/chkconfig --del perdition





Inetd Mode
----------

Perdition can be used in conjunction with inetd. This enables perdition to
benefit from tcpd where access can be controlled to some extent using
/etc/hosts.allow and /etc/hosts.deny.

To use perdition with inetd you need to add a line to /etc/inetd.conf and
then restart inetd. The following line was added to run perdition with
inetd under Red Hat 5.x and 6.x.:

pop-3   stream  tcp     nowait  root    /usr/sbin/tcpd perdition -i -P POP3
imap    stream  tcp     nowait  root    /usr/sbin/tcpd perdition -i -P IMAP4

inetd should then be restarted using.

/etc/rc.d/init.d/inet restart

The procedure for this may vary slightly on different installations.  In
particular the port may be known at pop3 instead of pop-3 in /etc/services
and it you may have to run killall -HUP inetd or kill -HUP <inetd pid> to
restart inetd.



Local Authentication
--------------------

Optionally perdition can be set up to authenticate the user locally once
the USER and PASS commands are entered by specifying the -a or
-authenticate_in option on the command line. This authentication happens
before the connection to the foreign server is made and must succeed for a
connection to the foreign server to be made.

This authentication uses PAM and a sample pam configuration file for
perdition can be found in etc/pam.d/perdition in the source tree. This
should be dropped into /etc/pam.d.


Domain Delimiter
----------------

A multi character domain delimiter can be set using the -d or --domain
delimiter option. This sets the delimiter used in conjunction with the
Strip Domain and User Port Specification options.


User Port Specification
-----------------------

If perdition is invoked with the -c or --client_server_specification flag
then the user may optionally specify the server and port that perdition
should connect to for the client using the syntax
user<delimiter>host[:port].

Example:
  IMAP4

  0 login henry@that.host:143

  POP3

  user james@other.host


Strip Domain
------------

IF strip domain is set using the -s|--strip_domain option then servers
giving usernames of the form user<delimiter>host[:port] will have the text
including and after <delimiter> removed from their username before
authentication takes place.  This option does not take effect if User Port
Specification, -c or --client_server_specification is turned on.


Idle Timeouts
-------------

If there is no input from the client or back-end server for greater than
timeout seconds then the connection is closed. The default timeout is 1800
seconds and can be specified on the command line with the -t or --timeout
option.  A time out of 0 means that timeouts are disabled and clients and
back-end servers can idle indefinitely.


Loop Detection
--------------

The greeting that perdition displays when accepting an incoming connection
is "+OK POP3 Ready <hostname>" or "* OK IMAP4 Ready <hostname>" in POP3 and
IMAP4 modes respectively. If when perdition connects to the back-end server
the greeting string matches the greeting string of the perdition process
making the connection then it is assumed that perdition is connecting to
itself and a "Re-Authentication Failure" is returned to the client.


Configuration File
------------------

The configuration file Format is <key> <value> where key is either a short
or long option as per perdition -h, without the leading - or --.  Blank
lines are ignored, as is anything including and after a # (hash) on a line.

Options that do not make sense in the configuration file such as h|help and
f|config_file  are ignored. Options specified on the command line override
the options in this file The options file can be reread at any time by
sending a SIGHUP to a perition process.

Example configuration File.

# perdition.conf
l           110             #Sort option used as key
group       mail            #Long option used as key
a                           #Option with no argument


Logging
-------

Logs are logged via syslog using the facility mail.  You should
inspect /etc/syslog.conf to find where these logs are written.
Under Red Hat 6.0 these logs will be written to /var/log/maillog,
under Solaris 7 these logs will be written to /var/log/syslog.
Normally each session will have two perdition log entries.
Logs are prepended, depending on syslog with the date, host, and
perdition[<pid>]: .

When the user connects the format of the logs is;

Connect: [<client_ip>-><server_ip> ]user=<username> server=<server> port=<port>

where 
   client_ip:The source ip address for the client.
   server_ip:The ip address that the connection was accepted for
             by the server.
             The client_ip, -> and server_ip will be ommited in inetd mode
   username: The username given by the user to perdition
   server:   The back end server for the user
   port:     The port to connect to on the server

Server will be "(null)" if no server was found.

When a user disconnects after a succesful connection to
a backend server the format of the log is;

Closing:  [<client_ip>-><server_ip> ]username=<username> <bytes_in> <bytes_out>

where:
   client_ip:The source ip address for the client.
   server_ip:The ip address that the connection was accepted for
             by the server.
             The client_ip, -> and server_ip will be ommited in inetd mode
  username:  The username given by the user to perdition
  bytes_in:  The number of bytes sent from the client to the server
  bytes_out: The number of bytes sent to the client from the server

Fatal errors are also logged. In stand alone mode the startup parameters
are logged on initialisation.  If the -d|--debug command line option or
configuration file directive is used then startup parameters are loged in
indetd mode and in both stand alone and identd mode additional debuging
messages are logged. As the flag implies, this is useful for debuging but
is probably to verbose for production systems.


Acknowledgements
----------------

I would like to give special thanks to Daniel Roesen
<droesen@entire-systems.com>, Youri <ya@lladm.net>, Frederic Delchambre
<dedel@freegates.be> and Clinton Work <work@scripty.com> for all their bug
reports and patches. Also I would like to thank VA Linux Systems,
http://valinux.com/ for paying me to work on cool pojects such as this.
Finally, thanks to Sun Microsystem, http://sun.com/ for loaning me
hardware to develop solaris compatibility on.
